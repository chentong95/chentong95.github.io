<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Node.js Stream(流) | CT的博客乐园</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Node.js Stream(流)</h1><a id="logo" href="/.">CT的博客乐园</a><p class="description">愿你历尽千帆，归来仍是少年。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Node.js Stream(流)</h1><div class="post-meta"><a href="/2017/07/20/node07/#comments" class="comment-count"></a><p><span class="date">Jul 20, 2017</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>Stream 是一个抽象接口，Node 中有很多对象实现了这个接口。<a id="more"></a>例如，对http 服务器发起请求的request 对象就是一个 Stream，还有stdout（标准输出）。<br><strong>Node.js，Stream 的四种流类型：</strong></p>
<ul>
<li>Readable - 可读操作。</li>
<li>Writable - 可写操作。</li>
<li>Duplex - 可读可写操作.</li>
<li>Transform - 操作被写入数据，然后读出结果。</li>
</ul>
<p><strong>所有的 Stream 对象都是 EventEmitter 的实例。常用的事件有：</strong></p>
<ul>
<li>data - 当有数据可读时触发。</li>
<li>end - 没有更多的数据可读时触发。</li>
<li>error - 在接收和写入过程中发生错误时触发。</li>
<li>finish - 所有数据已被写入到底层系统时触发。</li>
</ul>
<h2 id="从流中读取数据"><a href="#从流中读取数据" class="headerlink" title="从流中读取数据"></a>从流中读取数据</h2><p>创建 input.txt 文件，内容如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">又见花田半亩</div></pre></td></tr></table></figure></p>
<p>创建 main.js 文件, 代码如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">var fs = require("fs");</div><div class="line">var data = '';</div><div class="line">// 创建可读流</div><div class="line">var readerStream = fs.createReadStream('input.txt');</div><div class="line">// 设置编码为 utf8。</div><div class="line">readerStream.setEncoding('UTF8');</div><div class="line">// 处理流事件 --&gt; data, end, and error</div><div class="line">readerStream.on('data', function(chunk) &#123;</div><div class="line">   data += chunk;</div><div class="line">&#125;);</div><div class="line">readerStream.on('end',function()&#123;</div><div class="line">   console.log(data);</div><div class="line">&#125;);</div><div class="line">readerStream.on('error', function(err)&#123;</div><div class="line">   console.log(err.stack);</div><div class="line">&#125;);</div><div class="line">console.log("程序执行完毕");</div></pre></td></tr></table></figure></p>
<p>执行结果如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ node main.js</div><div class="line">程序执行完毕</div><div class="line">又见花田半亩</div></pre></td></tr></table></figure></p>
<h2 id="写入流"><a href="#写入流" class="headerlink" title="写入流"></a>写入流</h2><p>创建 main.js 文件, 代码如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">//引入require模块</div><div class="line">var fs = require("fs");</div><div class="line">var data = '又见花田半亩';</div><div class="line">// 创建一个可以写入的流，写入到文件 output.txt 中</div><div class="line">var writerStream = fs.createWriteStream('output.txt');</div><div class="line">// 使用 utf8 编码写入数据</div><div class="line">writerStream.write(data,'UTF8');</div><div class="line">// 标记文件末尾</div><div class="line">writerStream.end();</div><div class="line">// 处理流事件 --&gt; data, end, and error</div><div class="line">writerStream.on('finish', function() &#123;</div><div class="line">    console.log("写入完成。");</div><div class="line">&#125;);</div><div class="line">writerStream.on('error', function(err)&#123;</div><div class="line">   console.log(err.stack);</div><div class="line">&#125;);</div><div class="line">console.log("程序执行完毕");</div></pre></td></tr></table></figure></p>
<p>以上程序会将 data 变量的数据写入到 output.txt 文件中。代码执行结果如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ node main.js</div><div class="line">程序执行完毕</div><div class="line">写入完成。</div></pre></td></tr></table></figure></p>
<h2 id="管道流"><a href="#管道流" class="headerlink" title="管道流"></a>管道流</h2><p>管道提供了一个输出流到输入流的机制。通常我们用于从一个流中获取数据并将数据传递到另外一个流中。<br>我们把文件比作装水的桶，而水就是文件里的内容，我们用一根管子(pipe)连接两个桶使得水从一个桶流入另一个桶，这样就慢慢的实现了大文件的复制过程。<br>以下实例我们通过读取一个文件内容并将内容写入到另外一个文件中。<br>设置 input.txt 文件内容如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">又见花田半亩</div><div class="line">管道流操作实例</div></pre></td></tr></table></figure></p>
<p>创建 main.js 文件, 代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">var fs = require(<span class="string">"fs"</span>);</div><div class="line">// 创建一个可读流</div><div class="line">var readerStream = fs.createReadStream(<span class="string">'input.txt'</span>);</div><div class="line">// 创建一个可写流</div><div class="line">var writerStream = fs.createWriteStream(<span class="string">'output.txt'</span>);</div><div class="line">// 管道读写操作</div><div class="line">// 读取 input.txt 文件内容，并将内容写入到 output.txt 文件中</div><div class="line">readerStream.pipe(writerStream);</div><div class="line">console.log(<span class="string">"程序执行完毕"</span>);</div></pre></td></tr></table></figure></p>
<p>代码执行结果如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ node main.js</div><div class="line">程序执行完毕</div></pre></td></tr></table></figure></p>
<p>查看 output.txt 文件的内容：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cat output.txt</div><div class="line">又见花田半亩</div><div class="line">管道流操作实例</div></pre></td></tr></table></figure></p>
<h2 id="链式流"><a href="#链式流" class="headerlink" title="链式流"></a>链式流</h2><p>链式是通过连接输出流到另外一个流并创建多个对个流操作链的机制。链式流一般用于管道操作。<br>接下来我们就是用管道和链式来压缩和解压文件。<br>创建 compress.js 文件, 代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">var fs = require(<span class="string">"fs"</span>);</div><div class="line">var zlib = require(<span class="string">'zlib'</span>);</div><div class="line">// 压缩 input.txt 文件为 input.txt.gz</div><div class="line">fs.createReadStream(<span class="string">'input.txt'</span>)</div><div class="line">  .pipe(zlib.createGzip())</div><div class="line">  .pipe(fs.createWriteStream(<span class="string">'input.txt.zip'</span>));</div><div class="line">console.log(<span class="string">"文件压缩完成。"</span>);</div></pre></td></tr></table></figure></p>
<p>代码执行结果如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ node compress.js</div><div class="line">文件压缩完成。</div></pre></td></tr></table></figure></p>
<p>执行完以上操作后，我们可以看到当前目录下生成了 input.txt 的压缩文件 input.txt.gz。<br>接下来，让我们来解压该文件，创建 decompress.js 文件，代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">var fs = require(<span class="string">"fs"</span>);</div><div class="line">var zlib = require(<span class="string">'zlib'</span>);</div><div class="line">// 解压 input.txt.gz 文件为 input.txt</div><div class="line">fs.createReadStream(<span class="string">'input.txt.gz'</span>)</div><div class="line">  .pipe(zlib.createGunzip())</div><div class="line">  .pipe(fs.createWriteStream(<span class="string">'input.txt'</span>));</div><div class="line">console.log(<span class="string">"文件解压完成。"</span>);</div></pre></td></tr></table></figure></p>
<p>代码执行结果如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ node decompress.js</div><div class="line">文件解压完成。</div></pre></td></tr></table></figure></p>
</div><div class="tags"><a href="/tags/node/">node</a></div><div class="post-share"></div><div class="post-nav"><a href="/2017/07/20/node08/" class="pre">Node.js模块系统</a><a href="/2017/07/20/node06/" class="next">Node.js Buffer(缓冲区)</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#从流中读取数据"><span class="toc-text">从流中读取数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#写入流"><span class="toc-text">写入流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#管道流"><span class="toc-text">管道流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#链式流"><span class="toc-text">链式流</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/07/27/node18/">Node.js RESTful API</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/27/node17/">Node.js Express 框架</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/27/node16/">Node.js Web 模块</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/21/node15/">Node.js 工具模块</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/20/node14/">Node.js GET/POST请求</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/20/node13/">Node.js 文件系统</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/20/node12/">Node.js 常用工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/20/node11/">Node.js 全局对象</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/20/node10/">Node.js 路由</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/20/node09/">Node.js 函数</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/node/" style="font-size: 15px;">node</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://www.runoob.com/" title="菜鸟教程" target="_blank">菜鸟教程</a><ul></ul><a href="http://www.imooc.com/" title="慕课网" target="_blank">慕课网</a><ul></ul><a href="http://www.ui.cn/" title="UI中国" target="_blank">UI中国</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p> <span> Copyright &copy;<a href="/." rel="nofollow">又见花田半亩.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script></body></html>